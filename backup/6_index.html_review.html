<!-- static/index.html -->
<!doctype html>
<html lang="ko">

<!-- í—¤ë”ë¶€ë¶„ -->
<head>
  <meta charset="utf-8" />
  <title>ğŸ“ˆ Stock Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- íŒŒíŠ¸ë³„ë¡œ ìŠ¤íƒ€ì¼ css ê·œì¹™ ì •ì˜  -->
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px
    }

    h1 {
      margin-bottom: 12px
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px
    }

    input,
    select,
    button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 8px
    }

    a.button,
    button {
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: inline-block
    }

    a.button:hover,
    button:hover {
      background: #f5f5f5
    }

    .muted {
      color: #777;
      font-size: 12px;
      margin-left: 6px
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1000px
    }

    th,
    td {
      border: 1px solid #eee;
      padding: 8px;
      text-align: left
    }

    th {
      background: #fafafa
    }

    .section {
      margin-top: 18px
    }
  </style>
</head>

<!-- ë°”ë””ë¶€ë¶„ -->
<body>
  <h1>ğŸ“Š Stock Dashboard</h1>

  <!-- ìƒë‹¨ì˜ contorl ë°” = ê²€ìƒ‰í•˜ëŠ” ë¶€ë¶„ -->
  <div class="controls">
    <label>í‹°ì»¤:
      <input type="text" id="ticker" placeholder="AAPL, MSFT, 005930.KS" />
    </label>
    <button id="btnPrice">ê°€ê²© í™•ì¸</button>

    <label>ì§€ì—­:
      <select id="regionSelect"></select>
    </label>
    <button id="btnRegionNav">ì§€ì—­ í˜ì´ì§€ë¡œ ì´ë™</button>

    <!-- ë§í¬ë¡œ ì‹¤ì œ ì´ë™ -->
    <a href="/prices" id="linkAll" class="button">ì „ì²´ ì¡°íšŒ</a>
    <span class="muted" id="updatedAt"></span>
  </div>

  <!-- í•˜ë‹¨ì˜ result = ê²°ê³¼ ë‚˜ì˜¤ëŠ” ë¶€ë¶„ -->
  <div id="result"></div>

  <!-- ì´ ë¶€ë¶„ì´ jsì½”ë“œ -->
  <script>
    const $ = s => document.querySelector(s);
    const result = $('#result');
    const updatedAt = $('#updatedAt');
    const regionSelect = $('#regionSelect');

    // íŠ¹ì • ì§€ì—­(region)ì˜ ì£¼ì‹ ë¦¬ìŠ¤íŠ¸ë¥¼ HTML í…Œì´ë¸”ë¡œ ë Œë”ë§
    function renderRegion(region, items) {
      return `
        <div class="section">
          <h3>${region.toUpperCase()}</h3>
          <table>
            <tr><th>Name</th><th>Ticker</th><th>Price</th></tr>
            ${items.map(it =>
        `<tr>
                <td>${it.name ?? '-'}</td>
                <td>${it.ticker}</td>
                <td>${it.error ? '-' : it.price}</td>
              </tr>`).join('')}
          </table>
        </div>`;
    }

    // ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ í™”ë©´ì— í‘œì‹œ
    function renderAll(data) {
      result.innerHTML = Object.entries(data).map(([r, items]) => renderRegion(r, items)).join('');
      updatedAt.textContent = `Updated: ${new Date().toLocaleString()}`;
    }
    function renderSingle(item) {
      result.innerHTML = `
        <div class="section">
          <h3>ë‹¨ì¼ ì¢…ëª©</h3>
          <table>
            <tr><th>Name</th><th>Ticker</th><th>Price</th></tr>
            <tr>
              <td>${item.name ?? '-'}</td>
              <td>${item.ticker}</td>
              <td>${item.error ? '-' : item.price}</td>
            </tr>
          </table>
        </div>`;
      updatedAt.textContent = `Updated: ${new Date().toLocaleString()}`;
    }

    // ---------------- API í˜¸ì¶œ í•¨ìˆ˜ ----------------
    async function apiAll() { return fetch('/api/prices').then(r => r.json()); }
    async function apiRegion(r) { return fetch(`/api/prices/${r}`).then(r => r.json()); }
    async function apiPrice(t) { return fetch(`/api/price/${t}`).then(r => r.json()); }

    // ì§€ì—­ ì„ íƒ ë°•ìŠ¤ë¥¼ /api/prices ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì±„ìš°ê¸°
    async function fillRegions() {
      const data = await apiAll();
      regionSelect.innerHTML = '';
      Object.keys(data).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r; opt.textContent = r.toUpperCase();
        regionSelect.appendChild(opt);
      });
    }

    // ---------------- ì´ë²¤íŠ¸ ë“±ë¡ ----------------
    // "ê°€ê²© í™•ì¸" ë²„íŠ¼ í´ë¦­ â†’ ë‹¨ì¼ í‹°ì»¤ ì¡°íšŒ
    $('#btnPrice').addEventListener('click', async () => {
      const t = $('#ticker').value.trim();
      if (!t) { alert('í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
      const data = await apiPrice(t);
      renderSingle(data);
    });

    // ì§€ì—­ í˜ì´ì§€ë¡œ ì´ë™ (ì¿¼ë¦¬ ì‚¬ìš©)
    $('#btnRegionNav').addEventListener('click', () => {
      const r = regionSelect.value;
      if (!r) { alert('ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
      location.href = `/prices?region=${encodeURIComponent(r)}`;
    });

    // ---------------- ì´ˆê¸° ì‹¤í–‰ (í˜ì´ì§€ ë¡œë“œ ì‹œ) ----------------
    (async function init() {
      await fillRegions();

      const path = location.pathname.replace(/\/+$/, '');
      const params = new URLSearchParams(location.search);
      const region = params.get('region');

      // /prices ì§„ì…: region ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì—­ë§Œ, ì—†ìœ¼ë©´ ì „ì²´
      if (path === '/prices') {
        if (region) {
          const data = await apiRegion(region);
          result.innerHTML = renderRegion(data.region, data.results ?? []);
          updatedAt.textContent = `Updated: ${new Date().toLocaleString()}`;
        } else {
          const data = await apiAll();
          renderAll(data);
        }
      }
      // / (ë£¨íŠ¸)ëŠ” ê¸°ì¡´ì²˜ëŸ¼: í•„ìš” ì‹œ ì‚¬ìš©ìê°€ ë²„íŠ¼/ë§í¬ë¡œ ì¡°íšŒ
    })();
    // í‹°ì»¤ ì…ë ¥ì°½ì—ì„œ Enter í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
    $('#ticker').addEventListener('keyup', async (e) => {
      if (e.key === 'Enter') {
        const t = $('#ticker').value.trim();
        if (!t) { alert('í‹°ì»¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
        const data = await apiPrice(t);
        renderSingle(data);
      }
    });

  </script>
</body>

</html>